---
# DO NOT EDIT: Managed by Terraform at https://github.com/usetero/infrastructure
name: bot-signoff

# This workflow runs the same signoff process for bots that humans run locally.
# It handles:
# - Bot PRs (Renovate, Dependabot)
# - Master branch pushes (post-merge validation)
# - Manual trigger via 'ci' label
#
# Bots and humans follow the exact same validation process via 'task signoff'.

"on":
  workflow_dispatch:
  pull_request:
    types:
      - labeled
      - opened
      - synchronize
      - reopened
  push:
    branches: ["master"]

env:
  GOPRIVATE: github.com/usetero/

jobs:
  validate:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    if: contains(github.actor, '[bot]') || github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'ci')
    steps:
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2
        with:
          app-id: ${{ secrets.TERO_BOT_CLIENT_ID }}
          private-key: ${{ secrets.TERO_BOT_PRIVATE_SIGNING_KEY }}
          owner: ${{ github.repository_owner }}

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
      - uses: cashapp/activate-hermit@e49f5cb4dd64ff0b0b659d1d8df499595451155a # v1
        with:
          cache: "true"

      - run: git config --global url.https://x-access-token:${{ steps.generate-token.outputs.token }}@github.com/.insteadOf https://github.com/

      - run: gh extension install basecamp/gh-signoff
        env:
          GH_TOKEN: ${{ github.token }}

      - run: git config user.name "github-actions[bot]"
      - run: git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - if: github.actor == 'renovate[bot]'
        uses: stefanzweifel/git-auto-commit-action@778341af668090896ca464160c2def5d1d1a3eb0 # v6
        with:
          commit_message: "chore(renovate): auto-fix from CI"

      - run: task signoff
